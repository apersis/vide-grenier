{% extends "base.html" %}

{% block title %}Produit{% endblock %}

{% block body %}

<div class="content-wrapper upload-page edit-page">

    <!-- channel -->
    <div class="container-fluid add-header">
        <div class="row">
            <h1>
                Que souhaitez-vous donner ?
            </h1>
        </div>
    </div>
    <!-- ///channel -->

    <div class="container mt-30">
        <form id="productForm" action="" method="post" enctype="multipart/form-data">
            <div class="row">
                <div class="col-lg-6">
                    <div class="u-form">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="form-group">
                                    <label for="e1">Titre</label>
                                    <input type="text" name="name" class="form-control" id="titre"
                                           placeholder="Jeu de cartes (rare)">
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="form-group">
                                    <label for="e2">Description</label>
                                    <textarea class="form-control" name="description" id="description" rows="3" style="resize: none"></textarea>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="form-group">
                                    <label for="e2">Code Postal</label>
                                    <input type="text" id="codepostal" class="form-control cityAutoComplete" placeholder="29200" value="{{ user.city_code }}">
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="form-group">
                                    <label for="e2">Ville</label>
                                    <select name="fk_ville" id="villeInput" class="form-control">
                                        <option value="{{ user.city_id }}">{{ user.city_name }}</option>
                                    </select>
                                    
                                </div>
                            </div>

                            <div class="col-lg-12">
                                <div class="form-group">
                                    <label for="e3">Image</label>
                                    <input type="file" class="form-control" name="picture" id="e4" rows="3"/>
                                    {% if error %}
                                        <p class="text-danger">{{ error }}</p>
                                    {% endif %}
                                </div>
                            </div>        
                        </div>
                    </div>
            

                    <div class="u-area mt-small">
                        <form action="#" method="post">
                            <button name="submit" class="btn btn-primary u-btn">Valider</button>
                        </form>
                    </div>
                    <div class="u-terms">
                        <p>En soumettant votre article vous acceptez les <a href="#">conditions générales</a> de Vide Grenier en
                            ligne.</p>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock body %}

{% block javascript %}
    <script type="text/javascript">


            // Sélection de l'élément <select>
            const selectElement = document.getElementById('villeInput');

            const nameInput = document.getElementById('titre');
            const descriptionInput = document.getElementById('description');
            const codeInput = document.getElementById('codepostal');
            const pictureInput = document.getElementById('picture');
     

            // Fonction appellée lorsque l'utilisateur va taper des caractères dans le champ Code Postal
            $('#codepostal').autoComplete({
                resolver: 'custom',
                events: {
                    search: function (qry, callback) {
                        // On fait un appel a l'api pour recevoir tous les noms et id de ville qui correspondent au code postal
                        $.ajax(
                            '/api/cities',
                            {
                                data: { 'query': qry,
                                        'withcp' : 1}
                            }
                        ).done(function (res) {
                            callback(res)
                            // On clean la liste des villes a chaque nouveau resultat de l'appel
                            while (selectElement.options.length > 0) {
                                selectElement.remove(0);
                            }
                            //Pour chaque element du resultat de l'appel
                            res.forEach(element => {
                                // Création d'un nouvel élément <option>
                                var newOption = document.createElement('option');

                                // Attribution du nom de la ville dans le champ text
                                newOption.text = element[1];
                                // Attribution de l'id de la ville dans la valeur
                                newOption.value = element[0];
                                // On ajoute l'option au Select
                                selectElement.add(newOption)
                            });
                        });
                    }
                }
            });

    document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('productForm').addEventListener('submit', function(event) {
        event.preventDefault(); 


        if (nameInput.value.trim() === '') {
            nameInput.classList.add('input-error');
            setTimeout(function() {
                nameInput.classList.remove('input-error');
            }, 200);
            nameInput.focus();
            return;
        }

        if (descriptionInput.value.trim() === '') {
            descriptionInput.classList.add('input-error');
            setTimeout(function() {
                descriptionInput.classList.remove('input-error');
            }, 200);
            descriptionInput.focus();
            return;
        }

        if (codeInput.value.trim() === '') {
            codeInput.classList.add('input-error');
            setTimeout(function() {
                codeInput.classList.remove('input-error');
            }, 200);
            codeInput.focus();
            return;
        }

        if (selectElement.value.trim() === '') {
            selectElement.classList.add('input-error');
            setTimeout(function() {
                selectElement.classList.remove('input-error');
            }, 200);
            selectElement.focus();
            return;
        }

        if (pictureInput.value.trim() === '') {
            pictureInput.classList.add('input-error');
            setTimeout(function() {
                pictureInput.classList.remove('input-error');
            }, 200);
            pictureInput.focus();
            return;
        }

        // Si tous les champs sont remplis, soumettre le formulaire
        this.submit();
    });
});

    </script>
{% endblock %}
